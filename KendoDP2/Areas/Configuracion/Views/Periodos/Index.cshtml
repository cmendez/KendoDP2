@using Kendo.Mvc.UI
@using KendoDP2.Areas.Configuracion.Models
@{
    ViewBag.Title = "Periodos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{Html.RenderPartial("Titulo", new KendoDP2.Models.Helpers.PageTitle("Periodos", "Administre los periodos de la empresa"));}

<div class="portlet box green">
    <div class="portlet-title">
        <h4><i class="icon-reorder"></i>Periodos</h4>
        <div class="tools">
	        <a href="javascript:;" class="collapse"></a>
        </div>
	</div>
    
    <div class="portlet-body">
        <div class="row-fluid">
            <div class="span3 responsive">
                <a href="javascript:doEliminarPeriodo();" class="btn"><i class="icon-trash"></i> Eliminar el último periodo</a>
            </div>
        </div>
        <div class="row-fluid information-container">
            @(Html.Kendo().Grid<PeriodoDTO>()
                .Name("PeriodosGrid")
                .Columns(columns =>
                    {
                        columns.Bound(p => p.Nombre);
                        columns.Bound(p => p.FechaInicio).Visible(true);
                        columns.Bound(p => p.FechaFin).Visible(true);
                        columns.Command(command => { command.Edit().Text("Editar").UpdateText("Guardar").CancelText("Cancelar");}).Width(100);
                    }
                )
                .ToolBar(toolbar => toolbar.Create().Text("Registrar"))
                .Editable(editable => editable
                    .Mode(GridEditMode.PopUp)
                    .Window(w => w.Title("Ingrese los datos"))
                )
                .Pageable(paper => paper.Refresh(true))
                .Filterable()
                .Sortable()
                .Scrollable(p => p.Height(330))
                .DataSource(dataSource => dataSource
                    .Ajax()
                    .PageSize(20)
                    .Model(model => model.Id(p => p.ID))
                    .Create(update => update.Action("EditingInline_Create", "Periodos"))
                    .Read(read => read.Action("EditingInline_Read", "Periodos"))
                    .Update(update => update.Action("EditingInline_Update", "Periodos"))
                )
            )
        </div>
    </div>
</div>

<script type="text/javascript">
    function getValueFechaFin(value) {
        console.log(123123);
        if (value == null) {
            return "Activo";
        } else {
            return value;
        }
    }

    function doEliminarPeriodo() {
        var source = $('#PeriodosGrid').data('kendoGrid').dataSource;
        if (source._total == 1)
            alert("No puede tener menos de 1 periodo.");
        else if (confirm("¿Está consciente de que este cambio puede alterar el correcto funcionamiento de su empresa?"))
            $.ajax({
                url: '@Url.Action("EditingInline_Destroy", "Periodos", new { Area = "Configuracion" })',
                dataType: 'json',
                type: 'post',
                success: function () {
                    source.read();
                },
                error: function () {
                    alert("No se pudo realizar la operación");
                }
            });
    }

    function onComplete(e) {
        if (e.type == 'create' || e.type == 'destroy') {
            $('#PeriodosGrid').data('kendoGrid').dataSource.read();
        }
    }

    $(document).ready(function ready() {
        $('#PeriodosGrid').data('kendoGrid').dataSource.bind('requestEnd', onComplete);
    });
</script>
