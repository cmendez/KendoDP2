
@using Kendo.Mvc.UI
@using KendoDP2.Areas.Evaluacion360.Models
@using KendoDP2.Areas.Organizacion.Models
@model KendoDP2.Areas.Organizacion.Models.Funcion
@{
    ViewBag.Title = "Funciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
    IList<KendoDP2.Areas.Organizacion.Models.PuestoDTO> puestos = ViewBag.puestos;
    IList<KendoDP2.Areas.Organizacion.Models.FuncionDTO> funciones = ViewBag.funciones;
    
}

@{Html.RenderPartial("Titulo", new KendoDP2.Models.Helpers.PageTitle("Elegir evaluados", "Elija los colaboradores evaluados en este proceso"));}

<div class="portlet box green">
    <div class="portlet-title">
        <h4><i class="icon-reorder"></i>Procesos de evaluación</h4>
        <div class="tools">
            <a href="javascript:;" class="collapse"></a>
        </div>
    </div>
    <div class="portlet-body">
        <div class="row-fluid">
            
            <div class="span10">
                @(Html.Kendo().Grid<KendoDP2.Areas.Organizacion.Models.FuncionDTO>()
                .Name("Funciones    Grid")
                .Columns(columns =>
                    {
                        columns.Bound(p => p.Nombre);
                        columns.Bound(p => p.Peso);
                        
                        columns.Command(command =>
                        {
                            command.Destroy().Text("Eliminar");
                        }).Width(200);
                    }
                )
                .ToolBar(toolbar => 
                    {
                        toolbar.Custom().Text("Iniciar proceso").Action("IniciarProcesoEvaluacion", "ProcesoEvaluacion"); 
                        toolbar.Custom().Text("Cerrar Proceso").Action("CerrarProcesoEvaluacion", "ProcesoEvaluacion");
                        //toolbar.Template(@<text><a class='k-button'>Test toolbar</a></text>);
                            //"<a class='k-button' href='" + Url.Action("ElegirEvaluados", "ProcesoEvaluacion") + ">Test toolbar</a>");
                    }
                        )
                        .Editable(
                            e => e.DisplayDeleteConfirmation("¿Realmente desdea eliminar este registro?")
                        )
                        .Pageable(paper => paper.Refresh(true))
                        .Filterable()
                        .Sortable()
                        .Scrollable(w => w.Height(330))
                        .DataSource(dataSource => dataSource
                            .Ajax()
                            .PageSize(20)
                            .Model(model => { model.Id(p => p.ID); })
                            .Read(read => read.Action("ReadEvaluados", "ProcesoEvaluacion", new { procesoID = Model.ID }))
                            .Destroy(update => update.Action("DestroyEvaluados", "ProcesoEvaluacion"))
                            .Events(e => e.RequestEnd("requestEnd"))
                        )
                        )
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function(){
        cargaTiles();
    });
    function requestEnd(e){
        cargaTiles();
    }

    function cargaTilesAreas(){
        $.ajax({
            url: '@Url.Action("GetAreas", "ProcesoEvaluacion", new { Area = "Evaluacion360" })',
            dataType: 'JSON',
            type: 'GET',
            data: { procesoID : @Model.ID },
            success: function(response){
                $("#event_box_areas").html('');
                for(var i = 0; i < response.data.length; i++){
                    agregaTileDeArea(response.data[i].AreaDTO.ID, response.data[i].AreaDTO.Nombre);
                }
            }
        });
    }
    
    function cargaTilesColaboradores(){
        $.ajax({
            url: '@Url.Action("GetEvaluadosDirectos", "ProcesoEvaluacion", new { Area = "Evaluacion360" })',
            dataType: 'JSON',
            type: 'GET',
            data: { procesoID : @Model.ID },
            success: function(response){
                $("#event_box_colaboradores").html('');
                console.log('asdf');
                for(var i = 0; i < response.data.length; i++){
                    agregaTileDeColaborador(response.data[i].ColaboradorDTO.ID, response.data[i].ColaboradorDTO.NombreCompleto);
                }
            }
        });
    }

    function cargaTiles(){
        cargaTilesAreas();
        cargaTilesColaboradores();
    }
    function agregaTileDeArea(areaID, areaNombre){
        var newDiv = '<a href="javascript:removeArea(' + areaID + ');" class="label external-event">' + areaNombre + '<i class="icon-remove"></i></a>'; 
        $("#event_box_areas").append(newDiv);
    }
    function agregaTileDeColaborador(colaboradorID, nombreCompleto){
        var newDiv = '<a href="javascript: (' + colaboradorID + ');" class="label external-event">' + nombreCompleto + '<i class="icon-remove"></i></a>'; 
        $("#event_box_colaboradores").append(newDiv);
    }

    function removeColaborador(colaboradorID){
        $.ajax({
            url: '@Url.Action("DestroyEvaluadoDirecto", "ProcesoEvaluacion", new { Area = "Evaluacion360" })',
            dataType: 'JSON',
            type: 'POST',
            data: { procesoID : @Model.ID, colaboradorID : colaboradorID },
            success: function(response){
                cargaTiles();
                $("#ColaboradoresDeProcesoEvaluacionGrid").data('kendoGrid').dataSource.read();
            }
        });
    }
    function removeArea(areaID){
        $.ajax({
            url: '@Url.Action("DestroyArea", "ProcesoEvaluacion", new { Area = "Evaluacion360" })',
            dataType: 'JSON',
            type: 'POST',
            data: { procesoID : @Model.ID, areaID : areaID },
            success: function(response){
                cargaTiles();
                $("#ColaboradoresDeProcesoEvaluacionGrid").data('kendoGrid').dataSource.read();
            }
        });
    }

    function comboAreasSelection(e) {
        var comboAreas = $('#ComboAreas').data('kendoComboBox');
        if (comboAreas.selectedIndex == -1)
            return;
        var areaID = comboAreas.dataItem(comboAreas.selectedIndex).ID;
        var areaNombre = comboAreas.dataItem(comboAreas.selectedIndex).Nombre;
        console.log("area seleccionada:" + areaID);

        $.ajax({
            url: '@Url.Action("AddEvaluadosAreas", "ProcesoEvaluacion", new { Area = "Evaluacion360" })',
            dataType: 'JSON',
            type: 'POST',
            data: {procesoID: @Model.ID, areaID: areaID},
            success: function(data){
                if(data.success){
                    cargaTilesAreas();
                    $("#ColaboradoresDeProcesoEvaluacionGrid").data('kendoGrid').dataSource.read();
                }
                else {
                }
            },
            error: function(){
                alert("Hubo un error en la operación");
            }
        });
    };

    function comboColaboradoresSelection(e) {
        var comboColaboradores = $("#ComboColaboradores").data('kendoComboBox');
        if (comboColaboradores.selectedIndex == -1)
            return;
        var colaboradorID = comboColaboradores.dataItem(comboColaboradores.selectedIndex).ID;
        var colaboradorNombre = comboColaboradores.dataItem(comboColaboradores.selectedIndex).NombreCompleto;
        $.ajax({
            url: '@Url.Action("AddEvaluadosColaborador", "ProcesoEvaluacion", new { Area = "Evaluacion360" })',
            dataType: 'JSON',
            type: 'POST',
            data: {procesoID: @Model.ID, colaboradorID: colaboradorID},
            success: function(data){
                if(data.success){
                    cargaTilesColaboradores();
                    $("#ColaboradoresDeProcesoEvaluacionGrid").data('kendoGrid').dataSource.read();
                }
                else
                    alert("El colaborador seleccionado ya se encuentra en la lista de evaluados");
            },
            error: function(){        
                alert("Hubo un error en la operación");
            }
        });
    }
</script>
